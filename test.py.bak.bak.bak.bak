import json
import requests

startTok='<|im_start|>'
endTok='<|im_end|>'

responseLength=50
responseLength=100

class LlamaModel():
	def __init__(self,url,name,sysmsg):
		self.headers={"Content-type": "application/json"}
		self.url=url+'/completion'
		self.name=name
		self.sysmsg=sysmsg
		self.sysmsg=startTok+'system\n'+sysmsg+endTok+'\n'
		self.trailer=startTok+self.name+'\n'
		self.jsondata={
			'prompt':'',
			'n_predict':responseLength,
			'stream':True,
			'stop':[startTok,endTok],
		}
	def chatresp(self,messages):
		#self.jsondata['prompt']=messages
		self.jsondata['prompt']=self.sysmsg+messages+self.trailer
		strdata=json.dumps(self.jsondata)
		response=requests.post(self.url, data=strdata, headers=self.headers, stream=True)

		result=''

		print(self.name+': ')
		for line in response.iter_lines():
			if line:
				x=json.loads(line[6:])
				content=x['content']
				print(content,end='',flush=True)
				result+=content
		print()
		return result

#messages=startTok+'bob\nhi alice.'+endTok+'\n'
messages=startTok+'eve\nhi alice.'+endTok+'\n'
dolphin_url='http://192.168.68.107:8080'
capybara_url='http://192.168.68.107:8090'
airoboros_url='http://192.168.68.107:8070'

#dolphin=LlamaModel(dolphin_url,'alice','you are alice.  you\'re role playing being a wizard at hogwarts with your friends bob and eve.  bob will speak after you.')
#capybara=LlamaModel(capybara_url,'bob','you are bob.  you\'re role playing being a wizard at hogwarts with your friends alice and eve.  eve will speak after you.')
#airoboros=LlamaModel(airoboros_url,'eve','you are eve.  you\'re role playing being a wizard at hogwarts with your friends alice and bob.  alice will speak after you.')
#dolphin=LlamaModel(dolphin_url,'alice','you are alice.  you\'re role playing being a wizard at hogwarts with your friends bob and eve.  respond with ... to allow someone else to speak.')
#capybara=LlamaModel(capybara_url,'bob','you are bob.  you\'re role playing being a wizard at hogwarts with your friends alice and eve.  respond with ... to allow someone else to speak.')
#airoboros=LlamaModel(airoboros_url,'eve','you are eve.  you\'re role playing being a wizard at hogwarts with your friends alice and bob.  respond with ... to allow someone else to speak.')
dolphin=LlamaModel(dolphin_url,'alice','you are alice.  you\'re role playing being a wizard at hogwarts with your friends bob and eve.  respond with ... to allow someone else to speak.')
capybara=LlamaModel(capybara_url,'bob','you are bob.  you\'re role playing being a wizard at hogwarts with your friends alice and eve.  respond with ... to allow someone else to speak.')
airoboros=LlamaModel(airoboros_url,'eve','you are eve.  you\'re role playing being a wizard at hogwarts with your friends alice and bob.  respond with ... to allow someone else to speak.')

def chatOnce(llmmodel,messages):
	result=llmmodel.chatresp(messages)
	messages+=startTok+llmmodel.name+'\n'+result+'\n'
	return messages

chatrounds=5
for i in range(chatrounds):
	messages=chatOnce(dolphin,messages)
	messages=chatOnce(capybara,messages)
	messages=chatOnce(airoboros,messages)

#print()
#print(result)
